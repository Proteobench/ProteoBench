import json
from io import StringIO

import domaps


class Subcellprofile_Scores:
    def __init__(self):
        self.sd: domaps.SpatialDataSet = None
        self.sdc: domaps.SpatialDataSetComparison = None

    def generate_SpatialDataSet(
        self,
        content: StringIO,
        settings: dict,
    ) -> None:
        """
        Generate a SpatialDataset object from the content and settings.

        Input for this function should be generated by the io module.
        """
        sd = domaps.SpatialDataSet.from_settings(settings)
        sd.run_pipeline(content=content)
        self.sd = sd

    def create_sd_json(self, filename: str) -> None:
        """
        Create the JSON download file for the analysed datasets.
        """
        json.dump(self.sd.analysed_datasets_dict, filename, indent=4, sort_keys=True)

    def run_SpatialDataSetComparison(self):
        """
        Generate a SpatialDataSetComparison object from the SpatialDataSet object.
        """
        self.sdc = domaps.SpatialDataSetComparison()
        self.sdc.json_dict = self.sd.analysed_datasets_dict
        self.sdc.read_jsonFile()
        self.sdc.calc_biological_precision()
        self.sdc.calculate_global_scatter(metric="manhattan distance to average profile", consolidation="average")

    def get_metrics():
        """
        Return the metrics from the SpatialDataSetComparison object.
        """
        #     depth_id_1: int = 0
        # depth_profile_1: int = 0
        # depth_id_3: int = 0
        # depth_profile_3: int = 0
        # median_profile_reproducibility
        # average_complex_scatter
